Task: Refactor the code according to the specified goal

- Keep the commit isolated to this feature.
- Document but do not fix unrelated problems you find.
- Never add fallbacks/backward-compatibility/feature flags, we are always building the full new refactored solution.
